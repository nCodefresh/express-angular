version: '1.0'
steps:
  generate-tag:
    image: node:latest
    working-directory: ${{main_clone}}
    commands:
      - cf_export TAG=qwerty=we TAG1='kskd=sd' TAG2=fhgjd USERNAME=ncodefresh 123=124
      - echo TEST=123456789 >> /codefresh/volume/env_vars_to_export
      - echo TEST1=12345678910 >> /codefresh/volume/env_vars_to_export

  alpine-freestyle-step:
      image: alpine
      commands:
        - cf_export TAG_ALPINE=alpine
        - echo TEST_APINE=17 >> ${{CF_VOLUME_PATH}}/env_vars_to_export

  build_step_alpine:
    type: build
    description: codefresh example
    working_directory: ${{main_clone}}
    image-name: but-sdk
    dockerfile: Dockerfile.alpine

  build_step:
    type: build
    description: codefresh example
    working_directory: ${{main_clone}}
    image-name: ${{USERNAME}}/express-angular-test
    dockerfile: Dockerfile
    tag: ${{TAG2}}
    build_arguments:
      - arg=${{TEST_APINE}}

  generate-tag-1:
      image: node:latest
      working-directory: ${{main_clone}}
      commands:
        - echo ${TEST}
        - echo ${TAG}
        - echo ${TEST1}
        - echo ${123}
        - echo ${TAG_ALPINE}
        - echo ${TAG_ALPINE}

  unit_test:
    type: composition
    working_directory: ${{main_clone}}
    composition:
      version: '2'
      services:
        db:
          image: mysql:latest
          ports:
            - 3306
          environment:
            - MYSQL_ROOT_PASSWORD=admin
            - MYSQL_USER=test
            - MYSQL_PASSWORD=admin
            - MYSQL_DATABASE=my_db
    composition_candidates:
        test:
          image: node
          command: echo ${{TEST1}}

  push-to-dockerhub:
    type: push
    candidate: ${{build_step}}
    registry: docker-hub
    tag: ${{TAG2}}

  deploy_script:
    image: ${{build_step_alpine}}
    working_directory: IMAGE_WORK_DIR
    entry_point:
      - /bin/sh
      - /codefresh/volume/cf-generated/deploy_script
    create_file:
      path: /codefresh/volume/cf-generated
      name: deploy_script
      content: |-
        cat /codefresh/volume/env_vars_to_export
        ./deploy.sh