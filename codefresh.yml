version: '1.0'
steps:
  generate-tag:
    image: node:latest
    working-directory: ${{main_clone}}
    commands:
      - cf_export TAG=qwerty=we TAG1='kskd=sd' TAG2=fhgjd
      - echo TEST=123456789 >> /codefresh/volume/env_vars_to_export
      - echo TEST1=12345678910 >> /codefresh/volume/env_vars_to_export

  build_step:
    type: build
    description: codefresh example
    working_directory: ${{main_clone}}
    image-name: ncodefresh/express-angular-test
    dockerfile: Dockerfile
    tag: ${{TAG2}}

  unit_test:
    image: '${{build_step}}'
    working_directory: IMAGE_WORK_DIR
    commands:
      - echo ${{TAG}}
      - echo ${{TAG1}}
      - echo ${{TEST1}}
      - echo $TEST
    on_success:
      metadata:
        set:
          - '${{build_step.imageId}}':
              - CF_QUALITY: true
    on_fail:
      metadata:
        set:
          - '${{build_step.imageId}}':
              - CF_QUALITY: false

  freestyle-step-3:
    description: Freestyle step..
    title: Free styling 3
    image: nhoag/curl
    commands:
      - curl http://$TEST/index.php

  push-to-dockerhub:
    type: push
    candidate: ${{build_step}}
    registry: docker-hub
    tag: ${{TAG}}