version: '1.0'

steps:

  build-prj:
    type: build
    working-directory: ${{initial-clone}}
    description: codefresh example
    image-name: ncodefresh/express-angular-test
    dockerfile: Dockerfile
    fail-fast: false
    tag: ${{CF_SHORT_REVISION}}
    123-2: word
    build-arguments:
      - key=value
    on-fail: echo fail
    on-success: echo success
    on-finish: echo finish

  freestyle-step:
    image: node:latest
    working-directory : ${{initial-clone}}
    commands:
        - npm -v
    on-fail: echo fail
    on-success: echo success
    on-finish: echo finish

  push-step:
    type: push
    fail-fast: false
    candidate: ${{build-project}}
    tag: ${{CF_SHORT_REVISION}}

  composition-step:
    description: Attempting to run as part of composition.
    type: composition
    composition:
      version: '2'
      services:
        app:
          image: 'advance512demo/demochat:master'
          ports:
            - 5000
          depends_on:
            - mongo
        mongo:
          image: mongo
    composition-candidates:
      main:
        image: nhoag/curl
        command: bash -c "sleep 20 && curl http://app:5000/" | echo 'works'
    composition-variables:
      - TEST=qwerty
    entry-point: name

    launch_compose:
      type: launch-composition
      environment-name: env-service-name
      composition:
          version: '2'
          services:
            app:
              image: ${{build-prj}}
              ports:
                - 3000